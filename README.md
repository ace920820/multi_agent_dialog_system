# 多智能体驱动的智能医疗助手系统

## 系统概述

本项目开发了一个基于**多智能体（Multi-Agent）架构**的智能医疗助手系统。系统通过多个智能体协作，利用**AgentLite框架**实现医疗服务自动化。每个智能体都具有特定的功能，如预约挂号、导诊推荐和医疗咨询等，智能体之间通过任务分解与协作共同完成用户需求。系统通过动态对话和状态管理，持续收集和更新用户信息，确保服务的连续性、精准性和高效性。

## 核心功能

### 1. 医疗服务场景

**预约挂号服务**
- 收集用户基本信息（姓名、性别、年龄、联系方式）
- 了解就医需求（症状描述、科室偏好、就医时间）
- 推荐合适科室和医生
- 预约时间段管理

**导诊推荐服务**
- 症状信息采集
- 病史记录管理
- 智能科室匹配
- 医生专长匹配

**医疗咨询服务**
- 健康问题解答
- 就医建议提供
- 用药指导
- 检查解读

### 2. 对话状态管理

**用户信息管理**
- 动态信息收集
- 状态持续更新
- 历史记录追踪

**场景状态追踪**
- 当前服务场景识别
- 所需信息清单管理
- 已获取信息记录
- 信息完整性校验

### 3. API集成系统

**条件判断**
- 接口调用条件验证
- 必要信息完整性检查
- 业务规则验证

**智能调用**
- 自动接口选择
- 参数自动填充
- 结果状态跟踪

## 系统架构

### 核心组件

**管理智能体（ManagementAgent）**
- 管理整个服务流程，将任务分解并分配给不同的个体智能体
- 跟踪服务状态，确保每个子任务的完成
- 通过TaskPackage在管理智能体和个体智能体之间传递信息，实现智能体间协作

**个体智能体（Agent）**
- 由四个模块构成：PromptGen、Actions、LLM、Memory
- PromptGen：生成发送给LLM的提示
- Actions：定义智能体可执行的动作
- LLM：基于API调用生成动作
- Memory：存储动作与观察链，确保上下文的持续性
- 每个个体智能体都负责执行特定任务（如预约挂号、导诊推荐等）

**TaskPackage**
- 管理任务的划分、信息传递和结果合并
- 通过TaskPackage管理不同智能体间的信息流转和协作

### 智能体任务与角色分配

**预约挂号智能体**
- 负责收集用户基本信息，了解就医需求
- 推荐合适科室与医生，并管理预约时间段
- 接受管理智能体指令并与其他智能体协作

**导诊推荐智能体**
- 负责采集症状信息并推荐适当的科室
- 管理病史记录，并与医生专长进行匹配
- 协作提供诊断推荐信息

**医疗咨询智能体**
- 提供健康问题解答、就医建议、用药指导和检查解读
- 协作管理智能体和其他个体智能体提供综合医疗建议

## 项目结构

```
multi_agent_med_system/
├── README.md                  # 项目文档
├── main.py                    # 主程序入口
├── config/                    # 配置文件目录
│   ├── config.py              # 系统配置
│   └── prompts.py             # 提示词配置
├── agents/                    # 智能体模块
│   ├── __init__.py
│   ├── manager_agent.py       # 管理智能体
│   ├── appointment_agent.py   # 预约挂号智能体
│   ├── guide_agent.py         # 导诊推荐智能体
│   └── consultation_agent.py  # 医疗咨询智能体
├── actions/                   # 动作模块
│   ├── __init__.py
│   ├── appointment_actions.py # 预约相关动作
│   ├── guide_actions.py       # 导诊相关动作
│   └── consultation_actions.py# 咨询相关动作
├── models/                    # 数据模型
│   ├── __init__.py
│   ├── user.py                # 用户信息模型
│   ├── doctor.py              # 医生信息模型
│   ├── department.py          # 科室信息模型
│   └── appointment.py         # 预约信息模型
├── memory/                    # 记忆管理
│   ├── __init__.py
│   ├── memory_manager.py      # 记忆管理器
│   └── state_tracker.py       # 状态追踪器
├── api/                       # API接口
│   ├── __init__.py
│   ├── api_manager.py         # API管理器
│   └── mock_data_service.py   # 模拟数据服务
├── utils/                     # 工具函数
│   ├── __init__.py
│   ├── logger.py              # 日志工具
│   └── helpers.py             # 辅助函数
└── tests/                     # 测试目录
    ├── __init__.py
    ├── test_agents.py         # 智能体测试
    ├── test_actions.py        # 动作测试
    └── test_memory.py         # 记忆测试
```

## 关键模块详细说明

### 1. 数据模型（Models）

数据模型负责对对话流程中识别、产生或从API中获得的数据进行保存和管理，为智能体决策提供依据。

**用户信息模型（UserModel）**
- 负责存储和管理用户的基本信息、健康数据和就诊历史
- 提供添加症状、添加病史记录、添加就诊记录等功能
- 支持生成用户健康状况摘要和获取最近就诊记录

**医生信息模型（DoctorModel）**
- 负责存储和管理医生的基本信息、专业特长和排班信息
- 提供添加专业特长、添加擅长疾病、管理排班信息等功能
- 支持查询可预约时段和生成医生简介摘要

**科室信息模型（DepartmentModel）**
- 负责存储和管理科室的基本信息、医生列表和疾病类型
- 提供添加/移除医生、添加疾病类型、添加症状关键词等功能
- 支持症状与科室匹配和生成科室摘要

**预约信息模型（AppointmentModel）**
- 负责存储和管理用户的预约信息，包括预约状态跟踪和历史记录
- 提供确认预约、取消预约、完成预约等状态管理功能
- 支持检查预约冲突和生成预约摘要

### 2. API管理（API）

API管理模块负责对外部API接口调用的管理，包括错误处理、重试机制和缓存管理。

**API管理器（ApiManager）**
- 提供统一的API调用接口，支持GET、POST、PUT、DELETE等方法
- 实现错误处理和自动重试机制，提高系统稳定性
- 支持响应缓存，减少重复请求，提高性能
- 提供与模拟数据服务的集成，便于开发和测试

**模拟数据服务（计划中）**
- 提供模拟的医疗数据，包括科室、医生、排班信息等
- 模拟各种API响应场景，支持开发和测试
- 可配置的响应延迟和错误率，模拟真实环境

### 3. 记忆管理（Memory）

记忆管理模块负责对话状态的持久化和上下文管理，确保对话的连续性和智能体决策的有效性。

**记忆管理器（MemoryManager）**
- 负责存储和检索对话历史、用户信息和系统状态
- 实现短期记忆和长期记忆的分层管理
- 提供记忆搜索和过滤功能，便于智能体基于历史信息做出决策
- 支持记忆压缩和优先级排序，确保关键信息不被遗忘

**状态追踪器（StateTracker）**
- 跟踪当前对话的状态，包括当前任务进度、已获取的信息和待获取的信息
- 实现状态转换逻辑，控制对话流程的推进
- 提供状态检查功能，验证信息的完整性和有效性
- 支持事件触发机制，基于状态变化自动执行相应操作

## 运行指南

### 环境要求
- Python 3.9+
- AgentLite框架

### 安装依赖
```bash
pip install -r requirements.txt
```

### 运行系统
```bash
python main.py
```

## 系统工作流程

1. **用户输入处理**
   - 用户输入 -> 管理智能体分析 -> 任务分解 -> 个体智能体执行

2. **任务分解与指令传递**
   - 管理智能体 -> 将任务分解为子任务 -> 分配给个体智能体 -> 执行并反馈

3. **状态评估与信息验证**
   - 个体智能体 -> 状态检查 -> 信息完整性验证 -> 返回执行结果

4. **结果整合与响应生成**
   - 管理智能体 -> 汇总各个智能体的结果 -> 生成用户响应 -> 输出展示

## 系统优势

- **模块化设计**：每个智能体拥有独立的功能，可以灵活地进行功能扩展和调整。
- **高效的任务协作**：通过任务分解和TaskPackage管理，能够高效地协调多个智能体完成复杂的任务。
- **灵活性**：基于AgentLite框架，系统能够支持多种推理类型和智能体架构。
- **智能协作**：个体智能体之间通过信息传递和协作，能够提供综合性的医疗服务。
